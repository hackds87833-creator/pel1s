<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ver pel√≠cula</title>
<link rel="stylesheet" href="https://zonaaps-player.xyz/style.css">
<script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif}
body{
  background-color:#000;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  min-height:100vh;
  color:#fff;
  overflow-x:hidden;
}
.overlay{
  backdrop-filter:blur(1px);
  background:rgba(0,0,0,0.85);
  min-height:100vh;
  width:100%;
  padding:40px 20px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
.container{
  display:flex;
  align-items:flex-start;
  justify-content:center;
  flex-wrap:wrap;
  gap:40px;
  max-width:1200px;
  width:100%;
}
.poster{
  width:200px;
  border-radius:15px;
  box-shadow:0 8px 25px rgba(0,0,0,0.7);
  flex-shrink:0;
}
.info{
  flex:1;
  min-width:280px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}
.info-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:15px;
}
h1{
  font-size:2rem;
  font-weight:600;
  color:#fff;
  flex:1;
}
.details{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:15px;
  color:#ccc;
  font-size:0.95rem;
  margin-top:10px;
}
.rating-circle{
  position:relative;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#081c14;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  color:#00ff99;
  font-size:0.9rem;
  flex-shrink:0;
}
.rating-circle svg{
  position:absolute;
  top:0;left:0;
  transform:rotate(-80deg);
}
.stars{
  color:#00aaff;
  font-size:1rem;
}
.tags{
  margin-top:10px;
  color:#aaa;
  font-size:0.9rem;
}
.overview-box{
  background: rgba(0, 0, 0, 0.08);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:10px;
  padding:15px;
  color:#ccc;
  font-size:0.9rem;
  line-height:1.6;
  margin-top:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  max-height:160px;
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:#00ff99 #111;
}
.overview-box::-webkit-scrollbar{width:6px;}
.overview-box::-webkit-scrollbar-thumb{background:#00ff99;border-radius:4px;}
.overview-box::-webkit-scrollbar-track{background:#111;}
.buttons{
  display:flex;
  gap:12px;
  margin:20px 0;
  flex-wrap:wrap;
}
.btn{
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  padding:10px 18px;
  font-size:1rem;
}
.btn-blue{background:#007bff;color:#fff;}
.btn-yellow{background:#ffc107;color:#000;}
.btn:hover{opacity:0.9}
#player-container{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  margin-top:20px;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,0.7);
  background:#000;
}
#player{width:100%;height:100%}
#nativeVideo{width:100%;height:100%;background:#000;display:block;object-fit:contain}
.loading{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  color:#00ff99;
  font-weight:bold;
  font-size:1.1rem;
  z-index:3;
}
.resume-overlay{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.75);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;
}
.resume-overlay button{
  background:#00ff99;color:#000;font-weight:bold;border:none;
  padding:10px 18px;border-radius:8px;margin:8px;cursor:pointer;
}
.resume-overlay button:hover{background:#00cc7a}

/* Chromecast / Web Video Caster button */
.cast-btn{
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  width:42px;
  height:42px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(4px);
  background:rgba(0,0,0,0.45);
  border:1px solid rgba(255,255,255,0.06);
  cursor:pointer;
}
.cast-btn img{width:20px;height:20px;display:block;pointer-events:none}
.cast-btn:hover{background:rgba(255,255,255,0.04)}

/* small hint */
.cast-hint{
  position:absolute;
  top:58px;
  right:10px;
  z-index:1000;
  font-size:0.8rem;
  color:#ccc;
  background:rgba(0,0,0,0.6);
  padding:6px 8px;
  border-radius:6px;
  display:none;
}

/* responsive */
@media (max-width:900px){
  .container{flex-direction:column;align-items:center;text-align:center;}
  .poster{width:60%;max-width:200px;}
  .info-header{flex-direction:column;align-items:center;justify-content:center;}
  .info{text-align:center;align-items:center;}
  .details{justify-content:center;}
  .buttons{justify-content:center;}
  .overview-box{max-height:200px;}
}
@media (min-width:1600px){
  .poster{width:320px;}
  .info h1{font-size:2.3rem;}
  .overview-box{font-size:1.1rem;max-height:220px;}
}
</style>
</head>

<body>
<div class="overlay">
  <div class="container" id="movieContainer">
    <p class="loading">Cargando pel√≠cula...</p>
  </div>
</div>

<script>
/*
  Cambios solicitados:
  - Soporte universal de formatos (mp4, m3u8, webm, mkv, avi, mov, flv, etc.)
  - Mantener l√≥gica de JWPlayer + fallback nativo
  - Restaurada funci√≥n de guardar la posici√≥n y ofrecer reanudar
  - El custom-scheme WVC se construye en runtime (no aparece en HTML)
*/

/* --- Configuraci√≥n original / paths --- */
const TMDB_KEY="cc5b94165972aa509a349161d13d4fc9";
const TMDB_BASE="https://api.themoviedb.org/3";
const TMDB_IMG="https://image.tmdb.org/t/p/original";
const VIDEO_FOLDER="peliculas";
const FORMATS=[".mkv",".mp4",".m3u8",".avi",".mov",".webm",".flv"];
const JSON_PATH="data/enlaces.json";
const id=new URLSearchParams(window.location.search).get("id");

/* --- no mostrar el custom scheme en el HTML: lo guardamos parcial y lo codificamos --- */
const _wvc_prefix_b64 = btoa("wvc-x-callback://open?url=");
const _wvc_suffix_b64 = btoa("&secure_uri=true");

/* si no hay id */
if(!id){
  document.getElementById("movieContainer").innerHTML=`<div class="not-found">No se proporcion√≥ ID.</div>`;
}else{
  init();
}

async function init(){
  try{
    const res=await fetch(`${TMDB_BASE}/movie/${id}?api_key=${TMDB_KEY}&language=es-MX&append_to_response=credits`);
    const movie=await res.json();
    renderMovie(movie);
  }catch(e){
    document.getElementById("movieContainer").innerHTML=`<div class="not-found">Error al cargar la pel√≠cula.</div>`;
  }
}

function formatDate(d){
  if(!d)return"Desconocida";
  const p=d.split("-");
  return p[0];
}

function renderMovie(movie){
  if(movie.backdrop_path){
    document.body.style.backgroundImage=`url(${TMDB_IMG + movie.backdrop_path})`;
  }

  const container=document.getElementById("movieContainer");
  const rating=Math.round(movie.vote_average*10);
  const starsCount=Math.round(movie.vote_average/2);
  const stars="‚òÖ".repeat(starsCount)+"‚òÜ".repeat(5-starsCount);
  const genres=(movie.genres||[]).map(g=>g.name).join(", ");
  const country=(movie.production_countries?.[0]?.name)||"Desconocido";
  const director=(movie.credits?.crew?.find(p=>p.job==="Director")?.name)||"Desconocido";
  const cast=(movie.credits?.cast||[]).slice(0,5).map(a=>a.name).join(", ");

  container.innerHTML=`
    <img src="${TMDB_IMG + movie.poster_path}" class="poster" alt="poster">
    <div class="info">
      <div class="info-header">
        <h1>${movie.title}</h1>
        <div class="rating-circle">
          <svg width="55" height="55">
            <circle cx="27.5" cy="27.5" r="22" stroke="#004d00" stroke-width="5" fill="none"/>
            <circle cx="27.5" cy="27.5" r="22" stroke="#00ff99" stroke-width="5" fill="none"
              stroke-dasharray="138" stroke-dashoffset="${138 - (138*rating/100)}"/>
          </svg>${rating}%
        </div>
      </div>
      <div class="stars">${stars}</div>
      <div class="details">
        <span>üìÖ ${formatDate(movie.release_date)}</span>
        <span>‚è±Ô∏è ${movie.runtime || "?"} min</span>
        <span>üåé ${country}</span>
      </div>
      <div class="tags">üéûÔ∏è ${genres}</div>

      <div class="overview-box">
        ${movie.overview || "Sin descripci√≥n disponible."}
      </div>

      <p style="color:#00aaff;margin-top:10px;"><b>Director:</b> ${director}</p>
      <p style="color:#aaa;"><b>Reparto:</b> ${cast}</p>

      <div id="player-container">
        <div id="player"></div>
        <div class="loading" id="loading">Cargando video...</div>

        <!-- Bot√≥n de Cast (Chromecast / Web Video Caster) -->
        <div class="cast-btn" id="castBtn" title="Enviar a Web Video Caster / Cast">
          <!-- icono SVG inline (no muestra la url) -->
          <img src="data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'><path d='M1 18a1 1 0 0 1 1-1h.01'/><path d='M1 13a6 6 0 0 1 6 6'/><path d='M1 8a11 11 0 0 1 11 11'/><path d='M22 7v4a2 2 0 0 1-2 2h-3'/><path d='M22 3h-18a2 2 0 0 0-2 2v2'/></svg>`) }" alt="cast">
        </div>
        <div class="cast-hint" id="castHint">Env√≠o: Web Video Caster</div>
      </div>
    </div>
  `;
  loadVideo(id,movie);
}

/* Comprueba si existe el archivo con HEAD (intento r√°pido) */
async function fileExists(url){
  try{
    const r=await fetch(url,{method:"HEAD"});
    return r.ok;
  }catch{
    return false;
  }
}

/* --- principal: intenta enlaces.json, luego busqueda forzada en carpeta --- */
async function loadVideo(id,movie){
  let found=null;
  try{
    const res=await fetch(JSON_PATH);
    const data=await res.json();
    if(data[id])found=data[id];
  }catch(e){
    console.warn("No se pudo cargar enlaces.json",e);
  }

  if(!found){
    for(const ext of FORMATS){
      const url=`${window.location.origin}/${VIDEO_FOLDER}/${id}${ext}`;
      if(await fileExists(url)){found=url;break;}
    }
  }

  const playerDiv=document.getElementById("player");
  const loadingDiv=document.getElementById("loading");
  const castBtn=document.getElementById("castBtn");
  const castHint=document.getElementById("castHint");

  if(!found){
    loadingDiv.style.display="none";
    playerDiv.innerHTML=`<div class="not-found">üé¨ No disponible.</div>`;
    return;
  }

  /* --- ocultar el link del custom-scheme: no incluimos la cadena en el HTML.
        Construimos en runtime usando base64 parts y el url codificado --- */
  const encodedUrl = encodeURIComponent(found);
  function buildWvcCallback() {
    // decodificamos partes almacenadas y concatenamos
    const prefix = atob(_wvc_prefix_b64);
    const suffix = atob(_wvc_suffix_b64);
    return `${prefix}${encodedUrl}${suffix}`;
  }

  /* mostrar hint al pasar el mouse por encima del bot√≥n */
  castBtn.addEventListener('mouseenter',()=>{ castHint.style.display='block'; });
  castBtn.addEventListener('mouseleave',()=>{ castHint.style.display='none'; });

  castBtn.addEventListener('click',()=>{
    // Abrimos el custom scheme sin mostrarlo directamente en el HTML.
    // Para intentar evitar bloqueos de popups, primero intentamos location.href,
    // si falla, inyectamos un iframe temporal.
    try{
      const wvc = buildWvcCallback();
      // Primero intentamos abrir por location (esto puede activar la app si est√° instalada)
      window.location.href = wvc;
      // como segundo recurso, creamos iframe (algunos dispositivos manejan as√≠)
      setTimeout(()=>{
        const ifr = document.createElement('iframe');
        ifr.style.display='none';
        ifr.src = wvc;
        document.body.appendChild(ifr);
        setTimeout(()=>{ try{ document.body.removeChild(ifr);}catch{} },1500);
      },500);
    }catch(err){
      console.error("Error al intentar enviar a WVC:",err);
      alert("No se pudo iniciar el receptor de casting. Aseg√∫rate de tener instalada la app Web Video Caster o compatible.");
    }
  });

  /* --- actualizaci√≥n: soporte universal de formato --- */
  const ext = found.split('.').pop().toLowerCase();
  let type = "mp4";
  if(ext === "m3u8") type = "hls";
  else if(ext === "webm") type = "webm";
  else if(["mkv","avi","mov","flv"].includes(ext)) type = "mp4"; // fuerza MP4 para intentar reproducci√≥n

  // Variables para manejar guardado de tiempo y timers
  let jwPlayerInstance = null;
  let jwSaveInterval = null;
  let nativeSaveInterval = null;

  async function setupNativeVideo(src, poster) {
    // crea un elemento <video> nativo con controles ampliados
    playerDiv.innerHTML = `
      <video id="nativeVideo" playsinline webkit-playsinline controls crossorigin>
        <source src="${src}">
        Tu navegador no soporta la reproducci√≥n directa. Intenta descargar el archivo o usa otro navegador.
      </video>
    `;
    loadingDiv.style.display="none";
    const v = document.getElementById('nativeVideo');

    // si el navegador no reconoce mkv, get canPlayType suele devolver empty string
    try{
      // A√±adimos atajos personalizados: avance 10s / retroceso 10s con botones del teclado
      v.addEventListener('loadedmetadata',()=>{
        if(poster) v.setAttribute('poster', poster);
      });

      document.addEventListener('keydown',(e)=>{
        if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
        if(e.key === 'l' || e.key === 'L'){ v.currentTime = Math.min(v.duration || 0, v.currentTime + 10); }
        if(e.key === 'j' || e.key === 'J'){ v.currentTime = Math.max(0, v.currentTime - 10); }
        if(e.key === 'f' || e.key === 'F'){ if(document.fullscreenElement) document.exitFullscreen(); else v.requestFullscreen?.(); }
      });

      // guardado de tiempo cada 10s
      if(nativeSaveInterval) clearInterval(nativeSaveInterval);
      nativeSaveInterval = setInterval(()=>{
        const pos = v.currentTime || 0;
        if(pos > 0) localStorage.setItem(`movie_${id}_time`, pos);
      },10000);

      // resume overlay
      const savedTime = localStorage.getItem(`movie_${id}_time`);
      if(savedTime && parseFloat(savedTime) > 30){
        const overlay = document.createElement('div');
        overlay.className = 'resume-overlay';
        overlay.innerHTML = `<p style="color:#fff;margin-bottom:8px">¬øContinuar desde ${(savedTime/60).toFixed(1)} min?</p>
          <div><button id="resumeYes">S√≠</button><button id="resumeNo">No</button></div>`;
        document.getElementById('player-container').appendChild(overlay);
        document.getElementById('resumeYes').onclick = ()=>{ overlay.remove(); v.currentTime = parseFloat(savedTime); v.play(); };
        document.getElementById('resumeNo').onclick = ()=>{ overlay.remove(); v.play(); };
      }

      // si el navegador dice que no puede reproducir el tipo y la extensi√≥n es mkv, avisamos
      const can = v.canPlayType && v.canPlayType('video/x-matroska');
      if(ext === 'mkv' && (!can || can === '')) {
        // intentamos reproducir igual; si falla al reproducir, mostraremos mensaje
        v.addEventListener('error',()=>{
          playerDiv.innerHTML = `<div style="padding:20px;color:#ffcc00">Este navegador probablemente no reproduce .mkv nativamente. Intenta con .mp4 o usa otro navegador/dispositivo.</div>`;
        });
      }
    }catch(err){
      console.error("Error en setupNativeVideo", err);
    }
  }

  function tryJWPlayer(src, poster, forcedType) {
    try{
      // limpiamos intervalos anteriores si existieran
      if(jwSaveInterval) clearInterval(jwSaveInterval);
      if(nativeSaveInterval) clearInterval(nativeSaveInterval);

      // decisi√≥n de tipo: usamos 'type' calculado arriba
      const setupObj = {
        file: src,
        type: forcedType || type,
        width: "100%",
        height: "100%",
        mute: false,
        autostart: false,
        controls: true,
        playbackRateControls: true,
        skin:{name:"netflix"},
        stretching:"uniform",
        image: poster || ""
      };

      // Si ext es mkv, eliminamos type para que jw intente con HTML5 provider (si el navegador lo soporta)
      if(ext === 'mkv'){
        delete setupObj.type;
      }

      // inicializa jwplayer
      jwPlayerInstance = jwplayer("player").setup(setupObj);

      // eventos
      jwPlayerInstance.on('ready',()=>{
        if(loadingDiv) loadingDiv.style.display="none";

        // resume logic para jwplayer
        const savedTime = localStorage.getItem(`movie_${id}_time`);
        if(savedTime && parseFloat(savedTime) > 30){
          const overlay=document.createElement('div');
          overlay.className='resume-overlay';
          overlay.innerHTML=`<p style="color:#fff;margin-bottom:8px">¬øContinuar desde ${(savedTime/60).toFixed(1)} min?</p>
            <div><button id="resumeYes">S√≠</button><button id="resumeNo">No</button></div>`;
          document.getElementById('player-container').appendChild(overlay);
          document.getElementById('resumeYes').onclick=()=>{overlay.remove(); try{ jwPlayerInstance.seek(parseFloat(savedTime)); jwPlayerInstance.play(true); }catch(e){} };
          document.getElementById('resumeNo').onclick=()=>{overlay.remove(); try{ jwPlayerInstance.play(true); }catch(e){} };
        }

        // guardado de tiempo cada 10s para jw
        jwSaveInterval = setInterval(()=>{
          try{
            const pos = jwPlayerInstance.getPosition();
            if(pos > 0) localStorage.setItem(`movie_${id}_time`, pos);
          }catch(e){}
        },10000);
      });

      // si jw falla (error), fallback al video nativo
      jwPlayerInstance.on('error',(evt)=>{
        console.warn("Error JWPlayer:", evt);
        try{
          jwplayer("player").remove();
        }catch(e){}
        setupNativeVideo(src, poster);
      });

      // si jw no cambia a estado playing despu√©s de cierto tiempo, intentamos fallback (por ejemplo con mkv)
      let jwTried = false;
      jwPlayerInstance.on('play',(ev)=>{ jwTried = true; });
      setTimeout(()=>{
        try{
          const state = jwPlayerInstance.getState && jwPlayerInstance.getState();
          if(!jwTried && state !== 'playing' && state !== 'buffering'){
            try{ jwplayer("player").remove(); }catch(e){}
            setupNativeVideo(src, poster);
          }
        }catch(e){}
      },60000); // 10s de espera para detectar si JW no arranc√≥ (puedes ajustar si lo deseas)

      return jwPlayerInstance;
    }catch(err){
      console.warn("jwplayer setup failed:",err);
      setupNativeVideo(src, movie.backdrop_path?TMDB_IMG+movie.backdrop_path:null);
    }
  }

  // L√≥gica final: intentamos JWPlayer y si falla caemos al nativo
  tryJWPlayer(found, movie.backdrop_path?TMDB_IMG+movie.backdrop_path:null);
}
</script>

</body>
</html>
